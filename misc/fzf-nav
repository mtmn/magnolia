#!/bin/bash
repo=$(git rev-parse --show-toplevel)

alias rf='$repo/target/release/fzf-nav --db-path "$cdg/db/fzf.db" recent-files'
alias rd='$repo/target/release/fzf-nav --db-path "$cdg/db/fzf.db" recent-dirs'

d() {                                                                                                                                                                                                                                                                                                                          
    local target_dir=$(fd --hidden --exclude .git --type directory | fzf-down)                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                               
    if [[ -n "$target_dir" ]]; then                                                                                                                                                                                                                                                                                            
        cd "$target_dir" && fzf_log_directory_change "$target_dir"                                                                                                                                                                                                                                                             
    fi                                                                                                                                                                                                                                                                                                                         
}                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                               
f() {                                                                                                                                                                                                                                                                                                                          
    local file=$(fd --hidden --exclude .git | fzf-down)                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                               
    if [[ -n "$file" ]]; then                                                                                                                                                                                                                                                                                                  
        local ext="${file##*.}"                                                                                                                                                                                                                                                                                                
        local action                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                               
        case "$ext" in                                                                                                                                                                                                                                                                                                         
            mp4|flac|aiff|aif|mp3|mkv|avi|wav|webm)                                                                                                                                                                                                                                                                            
                action="media_player"                                                                                                                                                                                                                                                                                          
                mpv "$file" && fzf_log_file_open "$file" "$ext" "$action"                                                                                                                                                                                                                                                      
                ;;                                                                                                                                                                                                                                                                                                             
            jpg|jpeg|png|webp)                                                                                                                                                                                                                                                                                                 
                action="image_viewer"                                                                                                                                                                                                                                                                                          
                img2sixel "$file" && fzf_log_file_open "$file" "$ext" "$action"                                                                                                                                                                                                                                                
                ;;                                                                                                                                                                                                                                                                                                             
            pdf|epub|mobi)                                                                                                                                                                                                                                                                                                     
                action="document_reader"                                                                                                                                                                                                                                                                                       
                sioyek "$file" && fzf_log_file_open "$file" "$ext" "$action"                                                                                                                                                                                                                                                   
                ;;                                                                                                                                                                                                                                                                                                             
            *)                                                                 
                action="text_editor"                                                                                                                           
                "$EDITOR" "$file" && fzf_log_file_open "$file" "$ext" "$action" 
                ;;                                                             
        esac                       
    fi                                 
}                                                                              

fzf-down() {                                                                   
    fzf --height 50% --border                                             
}

fzf_log_directory_change() {
	target_dir="$1"
	db_path="$repo/db/fzf.db"

	abs_path=$(realpath "$target_dir" 2>/dev/null || echo "$target_dir")

	sqlite3 "$db_path" "INSERT INTO directory_history (path) VALUES ('$abs_path');"
}

fzf_log_file_open() {
	file_path="$1"
	file_type="$2"
	action="$3"
	db_path="$repo/db/fzf.db"

	abs_path=$(realpath "$file_path" 2>/dev/null || echo "$file_path")

	sqlite3 "$db_path" "INSERT INTO file_history (path, file_type, action) VALUES ('$abs_path', '$file_type', '$action');"
}
